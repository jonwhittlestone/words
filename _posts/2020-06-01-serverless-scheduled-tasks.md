---
keywords: fastai
description: Automating boot up and down of a Digital Ocean droplet with Slack notifications
title: Scheduled Severless Switch On
hide: true
toc: true 
badges: true
comments: true
categories: [aws lambda, automation, python]
image: images/chart-preview.png
show_image: true
nb_path: _notebooks/2020-06-01-serverless-scheduled-tasks.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-06-01-serverless-scheduled-tasks.ipynb
-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="The-Problem">The Problem<a class="anchor-link" href="#The-Problem"> </a></h1><p>As part of the Covid-19 effort, Digital Ocean donated some free credit to us to work on a local food delivery scheme.</p>
<p>To make that credit go as far as possible and to minimise power consumption, we'd like to power up and down the servers according to a schedule.</p>
<h1 id="The-Solution">The Solution<a class="anchor-link" href="#The-Solution"> </a></h1><p>Esimated cost saving...</p>
<p>Here's how to do that with AWS Lambda, with cloudfront events. We iterate on that to use the Serverless Framework.</p>
<h2 id="Prerequisites">Prerequisites<a class="anchor-link" href="#Prerequisites"> </a></h2><p>To follow along, there is a bit of set up involved to launch a Droplet that you can inspect with SSH if you need.</p>
<p>You will need to:</p>
<ul>
<li>.. have <code>jq</code> installed to format JSON responses<ul>
<li><a href="https://stedolan.github.io/jq/download/">Download JQ</a> for your OS</li>
</ul>
</li>
</ul>
<ul>
<li>.. <a href="https://www.digitalocean.com/docs/apis-clis/api/">generate</a> an access token so you can use the Digital Ocean API.</li>
</ul>
<ul>
<li><p>.. add the access token to your environment</p>

<pre><code>  $ export DIGITAL_OCEAN_ACCESS_TOKEN=[your_digital_ocean_token]</code></pre>
</li>
<li><p>.. have a <a href="https://www.digitalocean.com/docs/droplets/quickstart/#create-droplets">running Digital Ocean Droplet</a> with Docker installed.</p>
<ul>
<li><p>If you need to create one, use the following <a href="https://developers.digitalocean.com/documentation/v2/#create-a-new-droplet">API operation</a>.</p>

<pre><code>  $ curl -X POST \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
  -d '{"name":"scheduled-serverless","region":"lon1","size":"s-2vcpu-4gb","image":"docker-18-04"}' \
  "https://api.digitalocean.com/v2/droplets"</code></pre>
</li>
<li><p>.. <a href="https://8gwifi.org/sshfunctions.jsp">generate</a> and add the private key to your droplet. When generating, Select: <code>RSA</code> and <code>4096</code> and leave <code>Passphrase</code> blank. You may use the following API operation.</p>
</li>
<li><p>.. add the public key to your environment</p>
</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Shutdown-a-Droplet-with-CURL">Shutdown a Droplet with CURL<a class="anchor-link" href="#Shutdown-a-Droplet-with-CURL"> </a></h2><p>Assuming, your account only has one Digital Ocean droplet, the following CURL statement shows <code>active</code> status and the ID</p>

<pre><code>$ curl \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    "https://api.digitalocean.com/v2/droplets?name=scheduled-serverless" | jq '.droplets[0].status, .droplets[1].id'
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  4137    0  4137    0     0   7925      0 --:--:-- --:--:-- --:--:--  7940
"active"
194534673



</code></pre>
<p>Issuing the following <a href="https://developers.digitalocean.com/documentation/v2/#shutdown-a-droplet">CURL will</a> shut it down.</p>

<pre><code>curl -X POST \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
-d '{"type":"shutdown"}' \
"https://api.digitalocean.com/v2/droplets/194534673/actions"


</code></pre>
<p>We can then verify  the droplet has been powered down by reissuing the previous command from above. to show the 'active' status.</p>

<pre><code>...
"off"
194534673</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Power-on-a-Droplet-with-CURL">Power on a Droplet with CURL<a class="anchor-link" href="#Power-on-a-Droplet-with-CURL"> </a></h2><p>The action for powering on follows the same convention.</p>

<pre><code>$ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{"type":"power_on"}' \
    "https://api.digitalocean.com/v2/droplets/194534673/actions"


</code></pre>
<p>As befo</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Requests-scripts-in-AWS-Lambda">Requests scripts in AWS Lambda<a class="anchor-link" href="#Requests-scripts-in-AWS-Lambda"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Schedule-the-scripts-with-Cloudwatch-events">Schedule the scripts with Cloudwatch events<a class="anchor-link" href="#Schedule-the-scripts-with-Cloudwatch-events"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Serverless-framework">Serverless framework<a class="anchor-link" href="#Serverless-framework"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Team-notifications-with-Slack">Team notifications with Slack<a class="anchor-link" href="#Team-notifications-with-Slack"> </a></h2><p>As part of what's become known as 'Chatops', it's useful to update team members and stakeholders about the status of the server.</p>
<p>There are a variety of messaging platforms that have APIs such as Telegram or even SMS, but Slack has become one of the most popular.</p>

</div>
</div>
</div>
</div>
 

