<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><link href="https://words.howapped.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://words.howapped.com/" rel="alternate" type="text/html" /><updated>2020-07-01T06:48:55-05:00</updated><id>https://words.howapped.com/feed.xml</id><title type="html">howapped words</title><subtitle>Learnings and updates from the Howapped labs.</subtitle><entry><title type="html">hello world serverless microservice</title><link href="https://words.howapped.com/aws%20lambda/boto3/python/aws%20api%20gateway/2020/07/01/serverless-endpoint-with-aws-lambda-api-gateway-and-boto3.html" rel="alternate" type="text/html" title="hello world serverless microservice" /><published>2020-07-01T00:00:00-05:00</published><updated>2020-07-01T00:00:00-05:00</updated><id>https://words.howapped.com/aws%20lambda/boto3/python/aws%20api%20gateway/2020/07/01/serverless-endpoint-with-aws-lambda-api-gateway-and-boto3</id><content type="html" xml:base="https://words.howapped.com/aws%20lambda/boto3/python/aws%20api%20gateway/2020/07/01/serverless-endpoint-with-aws-lambda-api-gateway-and-boto3.html">&lt;!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-07-01-serverless-endpoint-with-aws-lambda-api-gateway-and-boto3.ipynb
--&gt;

&lt;div class=&quot;container&quot; id=&quot;notebook-container&quot;&gt;
        
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;

&lt;/div&gt;
    

&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h1 id=&quot;Problem&quot;&gt;Problem&lt;a class=&quot;anchor-link&quot; href=&quot;#Problem&quot;&gt; &lt;/a&gt;&lt;/h1&gt;&lt;p&gt;We've been asked for an API that will work at web scale and be cost effective. A serverless API is perfect for this.&lt;/p&gt;
&lt;p&gt;What are the constituent parts needed to start working with the AWS SDK with Python and steps needed to write and execute a serverless script with AWS Lambda. How can this script be invoked by an HTTP endpoint?&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h1 id=&quot;Solution&quot;&gt;Solution&lt;a class=&quot;anchor-link&quot; href=&quot;#Solution&quot;&gt; &lt;/a&gt;&lt;/h1&gt;&lt;p&gt;The companion repo consists utility code for deploying the lambda with &lt;a href=&quot;https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/lambda.html#lambda&quot;&gt;boto3&lt;/a&gt; as well as detail on the AWS API Gateway service that provides an endpoint to invoke the serverless function.&lt;/p&gt;
&lt;p&gt;This is the end product; A serverless endpoint.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/Ql676IX.png&quot; alt=&quot;End product - a simple serverless endpoint&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/jonwhittlestone/lambdapi&quot;&gt;code can be found on Github.&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Once cloned, install dependencies, set your AWS account ID as an environment variable and run it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(venv) (base) $ python src/main.py 

✅ Remove existing named lambda/api
✅ Create the lambda
✅ Deploy the lambda
✅ Remove any existing API
✅ Create API
✅ Deploy API
✅ Test API
SERVERLESS ENDPOINT RESPONSE from https://qvaik2un06.execute-api.eu-west-2.amazonaws.com/hello-world : 
b'{&quot;querystring_params:&quot;: {}, &quot;err&quot;: null, &quot;message&quot;: &quot;Hello Serverless World&quot;}'&lt;/code&gt;&lt;/pre&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Setup:-Creating-the-Lambda-function-and-deploying&quot;&gt;Setup: Creating the Lambda function and deploying&lt;a class=&quot;anchor-link&quot; href=&quot;#Setup:-Creating-the-Lambda-function-and-deploying&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;h3 id=&quot;Python-module-structure&quot;&gt;Python module structure&lt;a class=&quot;anchor-link&quot; href=&quot;#Python-module-structure&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Like this&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;lambdapi
├── src 
│   ├── __init__.py
│   ├── settings.py         # constants like AWS account
│   ├── main.py             # run me for instant results
|   └─── python_lambdas                   
|   |   └─── hello_world.py # serverless python function
│   ├── api_gateway.py      # boto3 for api_gateway
│   ├── lambda_functions.py # boto3 lambda
│   └── helpers.py          # file operations
└── ...&lt;/code&gt;&lt;/pre&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h3 id=&quot;AWS-Permissions-with-IAM&quot;&gt;AWS Permissions with IAM&lt;a class=&quot;anchor-link&quot; href=&quot;#AWS-Permissions-with-IAM&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;IAM Resources used - policies and roles.&lt;/p&gt;
&lt;p&gt;IAM Policies define the effect, actions, resources and optional conditions in a JSON document.&lt;/p&gt;
&lt;p&gt;An IAM user is a person or service that interacts with AWS with their own access to the management console. A user can have a policy attached to them. In this case it is more appropriate to grant policy access with an IAM role.
When assuming an IAM role (see Trusted Entity), access to a service can be granted to a user without having to give them new keys as the user can use temporary security tokens.&lt;/p&gt;
&lt;p&gt;Create an IAM Lambda access policy for IAM using an IAM client that you create.&lt;/p&gt;
&lt;p&gt;The access definition is provided in an &lt;code&gt;s3_access_policy_document&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JSON dictionary &lt;/li&gt;
&lt;li&gt;Action key &lt;code&gt;Statement&lt;/code&gt; with &lt;ul&gt;
&lt;li&gt;all S3 permissions&lt;/li&gt;
&lt;li&gt;Cloudwatch to create log groups and streams for monitoring of the lamdba events&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;After creating a policy, create role and attach it to an execution role by assuming the role.&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h3 id=&quot;Verifying-the-Lambda-was-created-on-AWS-Console&quot;&gt;Verifying the Lambda was created on AWS Console&lt;a class=&quot;anchor-link&quot; href=&quot;#Verifying-the-Lambda-was-created-on-AWS-Console&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;By way of sanity check, we can verify the Lambda function has been uploaded in the AWS Console.&lt;/p&gt;
&lt;p&gt;For the appropriate region, you may see the function, memory, timeout and our chosen permissions.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/RoOfCJt.gif&quot; alt=&quot;Animation of Console&quot; /&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;hr /&gt;
&lt;h2 id=&quot;Resources-used:-with-thanks-&amp;#128154;&quot;&gt;Resources used: with thanks &amp;#128154;&lt;a class=&quot;anchor-link&quot; href=&quot;#Resources-used:-with-thanks-&amp;#128154;&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Niyazi Erdogan's O'Reilly course - Build and Deploy Lambda functions AWS and Python &lt;a href=&quot;https://learning.oreilly.com/videos/build-and-deploy/9781838557751&quot;&gt;Videos&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Building Lambda Functions with Python &lt;a href=&quot;https://docs.aws.amazon.com/lambda/latest/dg/lambda-python.html&quot;&gt;AWS docs&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;boto3 AWS Python SDK &lt;a href=&quot;https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/lambda.html#lambda&quot;&gt;lambda docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html&quot;&gt;AWS Lambda Execution role&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Using AWS Lambda with Amazon API Gateway &lt;a href=&quot;https://docs.aws.amazon.com/lambda/latest/dg/services-apigateway-tutorial.html&quot;&gt;AWS Tutorial&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Setting up API Gateway and integrating it with Lambda proxy in Richard T. Freeman's serverless microservice course &lt;a href=&quot;https://learning.oreilly.com/videos/building-a-scalable/9781788622318/9781788622318-video4_3&quot;&gt;O'Reilly Videos&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html"></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://i.imgur.com/C2bPqfo.png" /><media:content medium="image" url="http://i.imgur.com/C2bPqfo.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Scheduled Severless Startup</title><link href="https://words.howapped.com/aws%20lambda/automation/python/2020/06/11/scheduled-serverless-startup.html" rel="alternate" type="text/html" title="Scheduled Severless Startup" /><published>2020-06-11T00:00:00-05:00</published><updated>2020-06-11T00:00:00-05:00</updated><id>https://words.howapped.com/aws%20lambda/automation/python/2020/06/11/scheduled-serverless-startup</id><content type="html" xml:base="https://words.howapped.com/aws%20lambda/automation/python/2020/06/11/scheduled-serverless-startup.html">&lt;!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-06-11-scheduled-serverless-startup.ipynb
--&gt;

&lt;div class=&quot;container&quot; id=&quot;notebook-container&quot;&gt;
        
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;

&lt;/div&gt;
    

&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h1 id=&quot;The-Problem&quot;&gt;The Problem&lt;a class=&quot;anchor-link&quot; href=&quot;#The-Problem&quot;&gt; &lt;/a&gt;&lt;/h1&gt;&lt;p&gt;As part of the Covid-19 effort, Digital Ocean donated some free credit to us to work on a local food delivery scheme.&lt;/p&gt;
&lt;p&gt;To make that credit go as far as possible and to minimise power consumption, we'd like to power up and down the servers according to a schedule.&lt;/p&gt;
&lt;h1 id=&quot;The-Solution&quot;&gt;The Solution&lt;a class=&quot;anchor-link&quot; href=&quot;#The-Solution&quot;&gt; &lt;/a&gt;&lt;/h1&gt;&lt;p&gt;Esimated cost saving...&lt;/p&gt;
&lt;p&gt;Here's how to do that with AWS Lambda, with cloudfront events. We iterate on that to use the Serverless Framework.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;TLDR; Have a look at the &lt;a href=&quot;https://github.com/jonwhittlestone/scheduled-serverless-startup&quot;&gt;companion repo.&lt;/a&gt;. It contains an example dockerized web app and the shell scripts for starting containers and creating the service.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This article covers how to automate with a Digital Ocean droplet so to follow along with the code, you can create one using the example from &lt;a href=&quot;http://words.howapped.com/systemd/automation/2020/06/01/automatically-restart-docker-after-reboot-with-service.html#cURL-to-create-the-droplet&quot;&gt;a previous article&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We will examine the cURL statements, convert those into Python. We can use AWS Lambda to execute the Python in a serverless environment. Then, the AWS lambda functions can be triggered by Cloudwatch events to a schedule so machines can be brought online only during operating hours.&lt;/p&gt;
&lt;p&gt;We can notify any interested parties using Microsoft Teams - a topic for a subsequent post.&lt;/p&gt;
&lt;h2 id=&quot;Prerequisites&quot;&gt;Prerequisites&lt;a class=&quot;anchor-link&quot; href=&quot;#Prerequisites&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;You can always check the &lt;a href=&quot;https://github.com/jonwhittlestone/scheduled-serverless-startup&quot;&gt;companion repo.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;You will need to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;.. have &lt;code&gt;jq&lt;/code&gt; installed to format JSON responses&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://stedolan.github.io/jq/download/&quot;&gt;Download JQ&lt;/a&gt; for your OS&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;.. have a server on which a dockerized web app will start automatically when the server is restarted&lt;ul&gt;
&lt;li&gt;See previous article on how to &lt;a href=&quot;http://words.howapped.com/systemd/automation/2020/06/01/automatically-restart-docker-after-reboot-with-service.html#cURL-to-create-the-droplet&quot;&gt;create one with DigitalOcean&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;.. have &lt;a href=&quot;https://boto3.amazonaws.com/v1/documentation/api/latest/guide/quickstart.html#installation&quot;&gt;installed Boto3 with your AWS account credentials&lt;/a&gt; so we can work with the AWS Python SDK.&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;cURL-statements-to-boot-down-and-up&quot;&gt;cURL statements to boot down and up&lt;a class=&quot;anchor-link&quot; href=&quot;#cURL-statements-to-boot-down-and-up&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As covered in a &lt;a href=&quot;http://words.howapped.com/systemd/automation/2020/06/01/automatically-restart-docker-after-reboot-with-service.html&quot;&gt;previous post&lt;/a&gt;, our web app will restart when rebooted using a systemd service.&lt;/p&gt;
&lt;p&gt;Rather than ssh or the cloud provider's control panel, the server can be started and stopped using cURL.&lt;/p&gt;
&lt;p&gt;In the case of DigitalOcean:&lt;/p&gt;
&lt;p&gt;Find out the ID of the server:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl \
        -H 'Content-Type: application/json' \
        -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    &quot;https://api.digitalocean.com/v2/droplets?name=scheduled-serverless&quot; | jq '.droplets[] | {id:.id, name:.name, status: .status}'&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The output gives us the ID&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
    ...
},
{
  &quot;id&quot;: 195786885,
  &quot;name&quot;: &quot;scheduled-serverless&quot;,
  &quot;status&quot;: &quot;active&quot;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And then power it down:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{&quot;type&quot;:&quot;power_off&quot;}' \
    &quot;https://api.digitalocean.com/v2/droplets/195786885/actions&quot; | jq '.[] | {id:.id, status:.status, type:.type}'&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Which tells us it's in progress&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;id&quot;: 955320153,
  &quot;status&quot;: &quot;in-progress&quot;,
  &quot;type&quot;: &quot;power_off&quot;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The equivalent cURL for powering on the server is virtual identical&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{&quot;type&quot;:&quot;power_on&quot;}' \
    &quot;https://api.digitalocean.com/v2/droplets/195786885/actions&quot; | jq '.[] | {id:.id, status:.status, type:.type}'&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The web app from the example is running on port 80. We know the server's IP address by referring to the control panel. Let's confirm that the service is running by verifying the output in a browser.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jonwhittlestone/words/master/images/do_ip.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Requests-scripts-in-AWS-Lambda&quot;&gt;Requests scripts in AWS Lambda&lt;a class=&quot;anchor-link&quot; href=&quot;#Requests-scripts-in-AWS-Lambda&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;h3 id=&quot;The-cURL-statements-in-Python&quot;&gt;The cURL statements in Python&lt;a class=&quot;anchor-link&quot; href=&quot;#The-cURL-statements-in-Python&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;First, get the ID of the droplet.&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;
&lt;div class=&quot;input&quot;&gt;

&lt;div class=&quot;inner_cell&quot;&gt;
    &lt;div class=&quot;input_area&quot;&gt;
&lt;div class=&quot; highlight hl-ipython3&quot;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;os&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;sys&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;requests&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;TOKEN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getenv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;DIGITAL_OCEAN_ACCESS_TOKEN&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;DROPLET_NAME&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;scheduled-serverless&amp;#39;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-Type&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;application/json&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&amp;#39;Authorization&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;sa&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;Bearer &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TOKEN&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TOKEN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;Your environment should have the `DIGITAL_OCEAN_ACCESS_TOKEN exported.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_droplet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;():&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;https://api.digitalocean.com/v2/droplets&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;droplets&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,{})&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;name&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DROPLET_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;DROPLET&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_droplet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sa&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;Droplet ID: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DROPLET&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;output_wrapper&quot;&gt;
&lt;div class=&quot;output&quot;&gt;

&lt;div class=&quot;output_area&quot;&gt;

&lt;div class=&quot;output_subarea output_stream output_stdout output_text&quot;&gt;
&lt;pre&gt;Droplet ID: 195786885
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
    

&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;p&gt;Now we have the ID, let's define the functions for bringing the servers down and back up.&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;
&lt;div class=&quot;input&quot;&gt;

&lt;div class=&quot;inner_cell&quot;&gt;
    &lt;div class=&quot;input_area&quot;&gt;
&lt;div class=&quot; highlight hl-ipython3&quot;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;power_off&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;dict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;{&amp;quot;type&amp;quot;:&amp;quot;power_off&amp;quot;}&amp;#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;url&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sa&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;https://api.digitalocean.com/v2/droplets/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DROPLET&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;/actions&amp;#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;post&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;power_on&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;dict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;{&amp;quot;type&amp;quot;:&amp;quot;power_on&amp;quot;}&amp;#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;url&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sa&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;https://api.digitalocean.com/v2/droplets/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DROPLET&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;/actions&amp;#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;post&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;action_resp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;power_off&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;action_resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;action&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;type&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;action_resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;action&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;status&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;----&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# action_resp = power_on()&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# print(action_resp[&amp;#39;action&amp;#39;][&amp;#39;type&amp;#39;])&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# print(action_resp[&amp;#39;action&amp;#39;][&amp;#39;status&amp;#39;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;output_wrapper&quot;&gt;
&lt;div class=&quot;output&quot;&gt;

&lt;div class=&quot;output_area&quot;&gt;

&lt;div class=&quot;output_subarea output_stream output_stdout output_text&quot;&gt;
&lt;pre&gt;power_off
in-progress
----
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
    

&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h3 id=&quot;Running-the-scripts-in-AWS-Lambda&quot;&gt;Running the scripts in AWS Lambda&lt;a class=&quot;anchor-link&quot; href=&quot;#Running-the-scripts-in-AWS-Lambda&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let's translate the cURL statements into Python.&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Schedule-the-scripts-with-Cloudwatch-events&quot;&gt;Schedule the scripts with Cloudwatch events&lt;a class=&quot;anchor-link&quot; href=&quot;#Schedule-the-scripts-with-Cloudwatch-events&quot;&gt; &lt;/a&gt;&lt;/h2&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Serverless-framework&quot;&gt;Serverless framework&lt;a class=&quot;anchor-link&quot; href=&quot;#Serverless-framework&quot;&gt; &lt;/a&gt;&lt;/h2&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Quality-of-Life-enhancements&quot;&gt;Quality of Life enhancements&lt;a class=&quot;anchor-link&quot; href=&quot;#Quality-of-Life-enhancements&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;When the target service is unavailable, it's quite unfriendly to show a blank 500 screen. A subsequent post outlines a solution for a forwarding service which can display an Open/Closed for business page to the user, with 'Opening times'&lt;/p&gt;
&lt;p&gt;As part of what's become known as 'Chatops', it's useful to update team members and stakeholders about the status of the server. A future addition will be to use the Microsoft Teams API to notify interested parties.&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h1 id=&quot;Resources&quot;&gt;Resources&lt;a class=&quot;anchor-link&quot; href=&quot;#Resources&quot;&gt; &lt;/a&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Curl converter - [&lt;a href=&quot;https://github.com/NickCarneiro/curlconverter&quot;&gt;github&lt;/a&gt;]&lt;/p&gt;
&lt;p&gt;convert curl commands to Python, JavaScript, PHP, R, Go, Rust, Dart, JSON, Ansible, Elixir&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html"></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://words.howapped.com/images/chart-preview.png" /><media:content medium="image" url="https://words.howapped.com/images/chart-preview.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Automatically restart docker containers after reboot</title><link href="https://words.howapped.com/systemd/automation/2020/06/01/automatically-restart-docker-after-reboot-with-service.html" rel="alternate" type="text/html" title="Automatically restart docker containers after reboot" /><published>2020-06-01T00:00:00-05:00</published><updated>2020-06-01T00:00:00-05:00</updated><id>https://words.howapped.com/systemd/automation/2020/06/01/automatically-restart-docker-after-reboot-with-service</id><content type="html" xml:base="https://words.howapped.com/systemd/automation/2020/06/01/automatically-restart-docker-after-reboot-with-service.html">&lt;!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-06-01-automatically-restart-docker-after-reboot-with-service.ipynb
--&gt;

&lt;div class=&quot;container&quot; id=&quot;notebook-container&quot;&gt;
        
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;

&lt;/div&gt;
    

&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h1 id=&quot;The-Problem&quot;&gt;The Problem&lt;a class=&quot;anchor-link&quot; href=&quot;#The-Problem&quot;&gt; &lt;/a&gt;&lt;/h1&gt;&lt;p&gt;As part of Covid-19 relief, DigitalOcean donated some free credit for me to work on a local food delivery scheme.&lt;/p&gt;
&lt;p&gt;I need to get most value for money by making that credit go as far as possible. It would also be nice to minimise power consumption.&lt;/p&gt;
&lt;h1 id=&quot;The-Solution&quot;&gt;The Solution&lt;a class=&quot;anchor-link&quot; href=&quot;#The-Solution&quot;&gt; &lt;/a&gt;&lt;/h1&gt;&lt;p&gt;The server should be powered-down outside of operating hours and turned back on before start of business. This can be done using the cloud provider's control panel.&lt;/p&gt;
&lt;p&gt;To avoid manual work starting the web app, a service is needed to bring the containers back online when the droplet is swtiched on.&lt;/p&gt;
&lt;p&gt;Covered in this article is the process for using the DigitalOcean API to create a droplet with the requisite &lt;code&gt;user_data&lt;/code&gt; for creating the &lt;code&gt;systemd&lt;/code&gt; service to start containers at boot time.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;TLDR; Have a look at the &lt;a href=&quot;https://github.com/jonwhittlestone/scheduled-serverless-startup&quot;&gt;companion repo.&lt;/a&gt;. It contains an example dockerized web app and the shell scripts for starting containers and creating the service.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Not covered in this article is the process to automate the power down and up to a schedule. This is covered in a subsequent article.&lt;/p&gt;
&lt;h2 id=&quot;Prerequisites&quot;&gt;Prerequisites&lt;a class=&quot;anchor-link&quot; href=&quot;#Prerequisites&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;A Digital Ocean account (free trial available)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.digitalocean.com/docs/apis-clis/api/&quot;&gt;Generate an access token&lt;/a&gt; for accessing the DigitalOcean API&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Add the token to your environment&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  $ export DIGITAL_OCEAN_ACCESS_TOKEN=XXXXXXXX&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;jq&lt;/code&gt; installed to format JSON responses&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://stedolan.github.io/jq/download/&quot;&gt;Download JQ&lt;/a&gt; for your OS&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Create-a-DigitalOcean-droplet-(optional)&quot;&gt;Create a DigitalOcean droplet (optional)&lt;a class=&quot;anchor-link&quot; href=&quot;#Create-a-DigitalOcean-droplet-(optional)&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;If you already have a web server, with an app, move to section, &lt;a href=&quot;#Create-a-systemd-service&quot;&gt;'Create a systemd service.'&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;If you do not already have a web server, launch a Droplet with requisite SSH access.&lt;/p&gt;
&lt;h3 id=&quot;cURL-to-create-the-droplet&quot;&gt;cURL to create the droplet&lt;a class=&quot;anchor-link&quot; href=&quot;#cURL-to-create-the-droplet&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This cURL statement creates an Ubuntu 18.04 server in London. The &lt;code&gt;user_data&lt;/code&gt; key in the payload is used for defining various statements to execute once the server is created. In this case we are cloning the &lt;a href=&quot;https://github.com/jonwhittlestone/scheduled-serverless-startup&quot;&gt;repo&lt;/a&gt; containing the dockerized app, starting it, and creating the systemd service to restart the app when the server boots up.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    $ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{&quot;name&quot;:&quot;scheduled-serverless&quot;,&quot;region&quot;:&quot;lon1&quot;,&quot;size&quot;:&quot;s-2vcpu-4gb&quot;,&quot;image&quot;:&quot;docker-18-04&quot;, &quot;user_data&quot;:
    &quot;#!/bin/bash
    apt-get update
    apt-get upgrade -y
    git clone https://github.com/jonwhittlestone/scheduled-serverless-startup.git /root/scheduled-serverless-startup
    sh /root/scheduled-serverless-startup/start-containers.sh
    sh /root/scheduled-serverless-startup/create-service.sh&quot;}' \
    &quot;https://api.digitalocean.com/v2/droplets&quot; 

&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;SSH-into-your-new-droplet&quot;&gt;SSH into your new droplet&lt;a class=&quot;anchor-link&quot; href=&quot;#SSH-into-your-new-droplet&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;You will be emailed your root password. 
After you SSH in using the provided password, you will be asked to change it.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://words.howapped.com/images/copied_from_nb/email.png&quot; alt=&quot;email.png&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;Test-the-web-app-is-running&quot;&gt;Test the web app is running&lt;a class=&quot;anchor-link&quot; href=&quot;#Test-the-web-app-is-running&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The app is running with Docker on port 80, so it's simply a case of:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@scheduled-serverless:~# curl localhost

A Howapped Project.

&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;Test-the-service-is-running&quot;&gt;Test the service is running&lt;a class=&quot;anchor-link&quot; href=&quot;#Test-the-service-is-running&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Restart your server with&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@scheduled-serverless:~# sudo reboot

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And then ssh and repeat the cURL statement to the web service&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(base) ➜  ~ ssh root@167.172.56.239 curl localhost
root@167.172.56.239's password: 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                             Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
A Howapped Project.

100    22  100    22    0     0   1294      0 --:--:-- --:--:-- --:--:--  1294&lt;/code&gt;&lt;/pre&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Create-a-systemd-service&quot;&gt;Create a systemd service&lt;a class=&quot;anchor-link&quot; href=&quot;#Create-a-systemd-service&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Ubuntu's init system is called &lt;code&gt;systemd&lt;/code&gt; and various flavours of Linux may have differing init systems.&lt;/p&gt;
&lt;h3 id=&quot;Scripting-the-starting-of-the-web-app&quot;&gt;Scripting the starting of the web app&lt;a class=&quot;anchor-link&quot; href=&quot;#Scripting-the-starting-of-the-web-app&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We need to define what should be automated which is starting the containers.&lt;/p&gt;
&lt;p&gt;In this case, I have an example dockerized app defined in the &lt;a href=&quot;https://github.com/jonwhittlestone/scheduled-serverless-startup&quot;&gt;companion repo&lt;/a&gt;, so let's clone that.&lt;/p&gt;
&lt;p&gt;If this directory is present (because it has been previously cloned), then just pull the latest changes.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/bin/bash

if [ -d &quot;/root/scheduled-serverless-startup&quot; ] 
then
    git pull origin master
else
    cd /root/scheduled-serverless-startup
     git clone https://github.com/jonwhittlestone/scheduled-serverless-startup.git /root/scheduled-serverless-startup
fi
cd /root/scheduled-serverless-startup/app
docker-compose up -d&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Lastly, we start containers with &lt;code&gt;docker-compose&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;Using-systemctl-to-enable-the-service&quot;&gt;Using &lt;code&gt;systemctl&lt;/code&gt; to enable the service&lt;a class=&quot;anchor-link&quot; href=&quot;#Using-systemctl-to-enable-the-service&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Using the interface &lt;code&gt;systemctl&lt;/code&gt; we can manage the init system. Each service is called a unit file. This means loading a service, &lt;a href=&quot;https://www.linode.com/docs/quick-answers/linux-essentials/introduction-to-systemctl/#enabling-a-service-at-boot&quot;&gt;enabling at boot&lt;/a&gt; and restarting.&lt;/p&gt;
&lt;p&gt;On an Ubuntu system, you may inspect the running services:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ systemctl status | head
● madebyjon
    State: running
     Jobs: 0 queued
   Failed: 0 units
    Since: Mon 2020-06-08 05:56:42 BST; 1 day 2h ago
   CGroup: /
           ├─3770 bpfilter_umh
           ├─user.slice
           │ └─user-1000.slice
           │   ├─user@1000.service&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The following &lt;a href=&quot;https://github.com/jonwhittlestone/scheduled-serverless-startup/blob/master/create-service.sh&quot;&gt;shell script&lt;/a&gt; creates the unit file, enables it at boot and starts the service.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/bin/bash
touch /etc/systemd/system/howapped.service
cat &amp;gt; /etc/systemd/system/howapped.service&amp;lt;&amp;lt;-EOF
    [Unit]
    Description=HowappedProjectStartOnBoot
    After=network.target
    [Service]
    Type=simple
    User=root
    WorkingDirectory=/root/scheduled-serverless-startup
    ExecStart=/bin/sh /root/scheduled-serverless-startup/start-containers.sh
    Restart=on-abort
    [Install]
    WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable howapped.service
systemctl restart howapped.service&lt;/code&gt;&lt;/pre&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Enable-the-systemd-service&quot;&gt;Enable the systemd service&lt;a class=&quot;anchor-link&quot; href=&quot;#Enable-the-systemd-service&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The below excerpt verifies we have the working directory created.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@scheduled-serverless:~/scheduled-serverless-startup# ls
README.md    app                create-service.sh
Vagrantfile  cloud-config.yaml  start-containers.sh
root@scheduled-serverless:~/scheduled-serverless-startup# pwd
/root/scheduled-serverless-startup&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And this runs the shell script to create the unit file and enable it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@scheduled-serverless:~/scheduled-serverless-startup# sh create-service.sh 
Created symlink /etc/systemd/system/multi-user.target.wants/howapped.service → /etc/systemd/system/howapped.service.&lt;/code&gt;&lt;/pre&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Test-it&quot;&gt;Test it&lt;a class=&quot;anchor-link&quot; href=&quot;#Test-it&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We will use the CURL statement to find the ID of our droplet, so that we can then use a CURL statement to power down the machine.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl \
        -H 'Content-Type: application/json' \
        -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    &quot;https://api.digitalocean.com/v2/droplets?name=scheduled-serverless&quot; | jq '.droplets[] | {id:.id, name:.name, status: .status}'

{
  &quot;id&quot;: 195393249,
  &quot;name&quot;: &quot;scheduled-serverless&quot;,
  &quot;status&quot;: &quot;on&quot;
}


# power it down
$ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{&quot;type&quot;:&quot;power_off&quot;}' \
    &quot;https://api.digitalocean.com/v2/droplets/195393249/actions&quot; | jq '.[] | {id:.id, status:.status, type:.type}'&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We power it back up:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{&quot;type&quot;:&quot;power_on&quot;}' \
    &quot;https://api.digitalocean.com/v2/droplets/195393249/actions&quot; | jq '.[] | {id:.id, status:.status, type:.type}'

{
  &quot;id&quot;: 953153688,
  &quot;status&quot;: &quot;in-progress&quot;,
  &quot;type&quot;: &quot;power_on&quot;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And verify our app is running.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ssh root@104.248.174.117 curl localhost
root@104.248.174.117's password: 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
A Howapped Project.&lt;/code&gt;&lt;/pre&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Clean-up&quot;&gt;Clean up&lt;a class=&quot;anchor-link&quot; href=&quot;#Clean-up&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;If you were following along by creating a DigitalOcean droplet, you may wish to power down or destroy the machine if not in use.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://words.howapped.com/images/copied_from_nb/destroy.png&quot; alt=&quot;destroy.png&quot; /&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Resources&quot;&gt;Resources&lt;a class=&quot;anchor-link&quot; href=&quot;#Resources&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.linode.com/docs/quick-answers/linux-essentials/introduction-to-systemctl/&quot;&gt;Linode - Introduction to Systemctl&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</content><author><name></name></author><summary type="html"></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://words.howapped.com/images/on.png" /><media:content medium="image" url="https://words.howapped.com/images/on.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>