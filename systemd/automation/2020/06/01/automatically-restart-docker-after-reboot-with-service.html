<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Automatically restart docker containers after reboot</h1><p class="page-description">Creating a cloud server and the service that restarts a web app when rebooted.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-06-01T00:00:00-05:00" itemprop="datePublished">
        Jun 1, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#systemd">systemd</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#automation">automation</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#The-Problem">The Problem </a></li>
<li class="toc-entry toc-h1"><a href="#The-Solution">The Solution </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Prerequisites">Prerequisites </a></li>
<li class="toc-entry toc-h2"><a href="#Create-a-DigitalOcean-droplet-(optional)">Create a DigitalOcean droplet (optional) </a>
<ul>
<li class="toc-entry toc-h3"><a href="#cURL-to-create-the-droplet">cURL to create the droplet </a></li>
<li class="toc-entry toc-h3"><a href="#SSH-into-your-new-droplet">SSH into your new droplet </a></li>
<li class="toc-entry toc-h3"><a href="#Test-the-web-app-is-running">Test the web app is running </a></li>
<li class="toc-entry toc-h3"><a href="#Test-the-service-is-running">Test the service is running </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Create-a-systemd-service">Create a systemd service </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Scripting-the-starting-of-the-web-app">Scripting the starting of the web app </a></li>
<li class="toc-entry toc-h3"><a href="#Using-systemctl-to-enable-the-service">Using systemctl to enable the service </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Enable-the-systemd-service">Enable the systemd service </a></li>
<li class="toc-entry toc-h2"><a href="#Test-it">Test it </a></li>
<li class="toc-entry toc-h2"><a href="#Clean-up">Clean up </a></li>
<li class="toc-entry toc-h2"><a href="#Resources">Resources </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-06-01-automatically-restart-docker-after-reboot-with-service.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="The-Problem">
<a class="anchor" href="#The-Problem" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Problem<a class="anchor-link" href="#The-Problem"> </a>
</h1>
<p>As part of Covid-19 relief, DigitalOcean donated some free credit for me to work on a local food delivery scheme.</p>
<p>I need to get most value for money by making that credit go as far as possible. It would also be nice to minimise power consumption.</p>
<h1 id="The-Solution">
<a class="anchor" href="#The-Solution" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Solution<a class="anchor-link" href="#The-Solution"> </a>
</h1>
<p>The server should be powered-down outside of operating hours and turned back on before start of business. This can be done using the cloud provider's control panel.</p>
<p>To avoid manual work starting the web app, a service is needed to bring the containers back online when the droplet is swtiched on.</p>
<p>Covered in this article is the process for using the DigitalOcean API to create a droplet with the requisite <code>user_data</code> for creating the <code>systemd</code> service to start containers at boot time.</p>
<p><strong>TLDR; Have a look at the <a href="https://github.com/jonwhittlestone/scheduled-serverless-startup">companion repo.</a>. It contains an example dockerized web app and the shell scripts for starting containers and creating the service.</strong></p>
<p>Not covered in this article is the process to automate the power down and up to a schedule. This is covered in a subsequent article.</p>
<h2 id="Prerequisites">
<a class="anchor" href="#Prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites<a class="anchor-link" href="#Prerequisites"> </a>
</h2>
<ul>
<li>A Digital Ocean account (free trial available)</li>
<li>
<a href="https://www.digitalocean.com/docs/apis-clis/api/">Generate an access token</a> for accessing the DigitalOcean API</li>
<li>
<p>Add the token to your environment</p>

<pre><code>  $ export DIGITAL_OCEAN_ACCESS_TOKEN=XXXXXXXX</code></pre>
</li>
<li>
<code>jq</code> installed to format JSON responses<ul>
<li>
<a href="https://stedolan.github.io/jq/download/">Download JQ</a> for your OS</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-a-DigitalOcean-droplet-(optional)">
<a class="anchor" href="#Create-a-DigitalOcean-droplet-(optional)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create a DigitalOcean droplet (optional)<a class="anchor-link" href="#Create-a-DigitalOcean-droplet-(optional)"> </a>
</h2>
<p>If you already have a web server, with an app, move to section, <a href="#Create-a-systemd-service">'Create a systemd service.'</a></p>
<p>If you do not already have a web server, launch a Droplet with requisite SSH access.</p>
<h3 id="cURL-to-create-the-droplet">
<a class="anchor" href="#cURL-to-create-the-droplet" aria-hidden="true"><span class="octicon octicon-link"></span></a>cURL to create the droplet<a class="anchor-link" href="#cURL-to-create-the-droplet"> </a>
</h3>
<p>This cURL statement creates an Ubuntu 18.04 server in London. The <code>user_data</code> key in the payload is used for defining various statements to execute once the server is created. In this case we are cloning the <a href="https://github.com/jonwhittlestone/scheduled-serverless-startup">repo</a> containing the dockerized app, starting it, and creating the systemd service to restart the app when the server boots up.</p>

<pre><code>    $ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{"name":"scheduled-serverless","region":"lon1","size":"s-2vcpu-4gb","image":"docker-18-04", "user_data":
    "#!/bin/bash
    apt-get update
    apt-get upgrade -y
    git clone https://github.com/jonwhittlestone/scheduled-serverless-startup.git /root/scheduled-serverless-startup
    sh /root/scheduled-serverless-startup/start-containers.sh
    sh /root/scheduled-serverless-startup/create-service.sh"}' \
    "https://api.digitalocean.com/v2/droplets" 

</code></pre>
<h3 id="SSH-into-your-new-droplet">
<a class="anchor" href="#SSH-into-your-new-droplet" aria-hidden="true"><span class="octicon octicon-link"></span></a>SSH into your new droplet<a class="anchor-link" href="#SSH-into-your-new-droplet"> </a>
</h3>
<p>You will be emailed your root password. 
After you SSH in using the provided password, you will be asked to change it.</p>
<p><img src="http://words.howapped.com/images/copied_from_nb/email.png" alt="email.png"></p>
<h3 id="Test-the-web-app-is-running">
<a class="anchor" href="#Test-the-web-app-is-running" aria-hidden="true"><span class="octicon octicon-link"></span></a>Test the web app is running<a class="anchor-link" href="#Test-the-web-app-is-running"> </a>
</h3>
<p>The app is running with Docker on port 80, so it's simply a case of:</p>

<pre><code>root@scheduled-serverless:~# curl localhost

A Howapped Project.

</code></pre>
<h3 id="Test-the-service-is-running">
<a class="anchor" href="#Test-the-service-is-running" aria-hidden="true"><span class="octicon octicon-link"></span></a>Test the service is running<a class="anchor-link" href="#Test-the-service-is-running"> </a>
</h3>
<p>Restart your server with</p>

<pre><code>root@scheduled-serverless:~# sudo reboot

</code></pre>
<p>And then ssh and repeat the cURL statement to the web service</p>

<pre><code>(base) ➜  ~ ssh root@167.172.56.239 curl localhost
root@167.172.56.239's password: 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                             Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
A Howapped Project.

100    22  100    22    0     0   1294      0 --:--:-- --:--:-- --:--:--  1294</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-a-systemd-service">
<a class="anchor" href="#Create-a-systemd-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create a systemd service<a class="anchor-link" href="#Create-a-systemd-service"> </a>
</h2>
<p>Ubuntu's init system is called <code>systemd</code> and various flavours of Linux may have differing init systems.</p>
<h3 id="Scripting-the-starting-of-the-web-app">
<a class="anchor" href="#Scripting-the-starting-of-the-web-app" aria-hidden="true"><span class="octicon octicon-link"></span></a>Scripting the starting of the web app<a class="anchor-link" href="#Scripting-the-starting-of-the-web-app"> </a>
</h3>
<p>We need to define what should be automated which is starting the containers.</p>
<p>In this case, I have an example dockerized app defined in the <a href="https://github.com/jonwhittlestone/scheduled-serverless-startup">companion repo</a>, so let's clone that.</p>
<p>If this directory is present (because it has been previously cloned), then just pull the latest changes.</p>

<pre><code>#!/bin/bash

if [ -d "/root/scheduled-serverless-startup" ] 
then
    git pull origin master
else
    cd /root/scheduled-serverless-startup
     git clone https://github.com/jonwhittlestone/scheduled-serverless-startup.git /root/scheduled-serverless-startup
fi
cd /root/scheduled-serverless-startup/app
docker-compose up -d</code></pre>
<p>Lastly, we start containers with <code>docker-compose</code></p>
<h3 id="Using-systemctl-to-enable-the-service">
<a class="anchor" href="#Using-systemctl-to-enable-the-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using <code>systemctl</code> to enable the service<a class="anchor-link" href="#Using-systemctl-to-enable-the-service"> </a>
</h3>
<p>Using the interface <code>systemctl</code> we can manage the init system. Each service is called a unit file. This means loading a service, <a href="https://www.linode.com/docs/quick-answers/linux-essentials/introduction-to-systemctl/#enabling-a-service-at-boot">enabling at boot</a> and restarting.</p>
<p>On an Ubuntu system, you may inspect the running services:</p>

<pre><code>$ systemctl status | head
● madebyjon
    State: running
     Jobs: 0 queued
   Failed: 0 units
    Since: Mon 2020-06-08 05:56:42 BST; 1 day 2h ago
   CGroup: /
           ├─3770 bpfilter_umh
           ├─user.slice
           │ └─user-1000.slice
           │   ├─user@1000.service</code></pre>
<p>The following <a href="https://github.com/jonwhittlestone/scheduled-serverless-startup/blob/master/create-service.sh">shell script</a> creates the unit file, enables it at boot and starts the service.</p>

<pre><code>#!/bin/bash
touch /etc/systemd/system/howapped.service
cat &gt; /etc/systemd/system/howapped.service&lt;&lt;-EOF
    [Unit]
    Description=HowappedProjectStartOnBoot
    After=network.target
    [Service]
    Type=simple
    User=root
    WorkingDirectory=/root/scheduled-serverless-startup
    ExecStart=/bin/sh /root/scheduled-serverless-startup/start-containers.sh
    Restart=on-abort
    [Install]
    WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable howapped.service
systemctl restart howapped.service</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Enable-the-systemd-service">
<a class="anchor" href="#Enable-the-systemd-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enable the systemd service<a class="anchor-link" href="#Enable-the-systemd-service"> </a>
</h2>
<p>The below excerpt verifies we have the working directory created.</p>

<pre><code>root@scheduled-serverless:~/scheduled-serverless-startup# ls
README.md    app                create-service.sh
Vagrantfile  cloud-config.yaml  start-containers.sh
root@scheduled-serverless:~/scheduled-serverless-startup# pwd
/root/scheduled-serverless-startup</code></pre>
<p>And this runs the shell script to create the unit file and enable it.</p>

<pre><code>root@scheduled-serverless:~/scheduled-serverless-startup# sh create-service.sh 
Created symlink /etc/systemd/system/multi-user.target.wants/howapped.service → /etc/systemd/system/howapped.service.</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test-it">
<a class="anchor" href="#Test-it" aria-hidden="true"><span class="octicon octicon-link"></span></a>Test it<a class="anchor-link" href="#Test-it"> </a>
</h2>
<p>We will use the CURL statement to find the ID of our droplet, so that we can then use a CURL statement to power down the machine.</p>

<pre><code>$ curl \
        -H 'Content-Type: application/json' \
        -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    "https://api.digitalocean.com/v2/droplets?name=scheduled-serverless" | jq '.droplets[] | {id:.id, name:.name, status: .status}'

{
  "id": 195393249,
  "name": "scheduled-serverless",
  "status": "on"
}


# power it down
$ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{"type":"power_off"}' \
    "https://api.digitalocean.com/v2/droplets/195393249/actions" | jq '.[] | {id:.id, status:.status, type:.type}'</code></pre>
<p>We power it back up:</p>

<pre><code>$ curl -X POST \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer '$DIGITAL_OCEAN_ACCESS_TOKEN'' \
    -d '{"type":"power_on"}' \
    "https://api.digitalocean.com/v2/droplets/195393249/actions" | jq '.[] | {id:.id, status:.status, type:.type}'

{
  "id": 953153688,
  "status": "in-progress",
  "type": "power_on"
}</code></pre>
<p>And verify our app is running.</p>

<pre><code>$ ssh root@104.248.174.117 curl localhost
root@104.248.174.117's password: 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
A Howapped Project.</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Clean-up">
<a class="anchor" href="#Clean-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Clean up<a class="anchor-link" href="#Clean-up"> </a>
</h2>
<p>If you were following along by creating a DigitalOcean droplet, you may wish to power down or destroy the machine if not in use.</p>
<p><img src="http://words.howapped.com/images/copied_from_nb/destroy.png" alt="destroy.png"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Resources">
<a class="anchor" href="#Resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resources<a class="anchor-link" href="#Resources"> </a>
</h2>
<ul>
<li><a href="https://www.linode.com/docs/quick-answers/linux-essentials/introduction-to-systemctl/">Linode - Introduction to Systemctl</a></li>
</ul>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/systemd/automation/2020/06/01/automatically-restart-docker-after-reboot-with-service.html" hidden></a>
</article>